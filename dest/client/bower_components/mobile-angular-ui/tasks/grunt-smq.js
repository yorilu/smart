var cssParse,cssStringify,fs,parameterize,path,util;util=require("util"),parameterize=require("parameterize"),fs=require("fs"),path=require("path"),cssParse=require("css-parse"),cssStringify=require("css-stringify"),module.exports=function(e){return e.task.registerMultiTask("smq","Split Css by Media Queries",function(){var t,n,r;t=this.data,r=e.file.expand({cwd:t.cwd||"."},t.src),n=t.dest||".";try{e.file.mkdir(n)}catch(i){}return r.forEach(function(e){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;l=t.basename||path.basename(e,path.extname(e)),u=path.resolve(t.cwd||".",e),c=path.resolve(n,l+"-base.css"),r=fs.readFileSync(u).toString(),v=cssParse(r),p=v.stylesheet.rules||[],a={};for(o=m=y=p.length-1;y<=0?m<=0:m>=0;o=y<=0?++m:--m)h=p[o],h.type==="media"&&(a[g=h.media]==null&&(a[g]=[]),(h.rules||[]).forEach(function(e){return a[h.media].unshift(e)}),p.splice(o,1));fs.writeFileSync(c,cssStringify(v));for(f in a)p=a[f],s=parameterize(f),i=path.resolve(n,l+"-"+s+".css"),d={type:"stylesheet",stylesheet:{rules:[{type:"media",media:f,rules:p}]}},fs.writeFileSync(i,cssStringify(d))})})}