/**

 * UI-Router Extras: Sticky states, Future States, Deep State Redirect, Transition promise
 * Module: sticky
 * @version 0.0.13
 * @link http://christopherthielen.github.io/ui-router-extras/
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */

(function(e,t){function r(t,n){var r=n,i=r.inheritParams,s=r.protoKeys,o=r.map,u={},a={},l,c=!1;this.registerStickyState=function(e){a[e.name]=e},this.enableDebug=this.debugMode=function(t){return e.isDefined(t)&&(c=t),c},this.$get=["$rootScope","$state","$stateParams","$injector","$log",function(t,n,r,a,l){function h(){var t={};return e.forEach(u,function(e,n){var r=p(e);for(var i=0;i<r.length;i++){var s=r[i].parent;t[s.name]=t[s.name]||[],t[s.name].push(e)}t[""]&&(t.__inactives=t[""])}),t}function p(e){var t=[];if(!e)return t;do e.sticky&&t.push(e),e=e.parent;while(e);return t.reverse(),t}function d(e,t,n){if(e[n]===t[n])return{from:!1,to:!1};var r=n<e.length&&e[n].self.sticky,i=n<t.length&&t[n].self.sticky;return{from:r,to:i}}function v(e,t,n,r){if(r)return"updateStateParams";var i=u[e.self.name];if(!i)return"enter";if(e.self===n)return"updateStateParams";var s=g(t,i.locals.globals.$stateParams,e.ownParams);return s?"reactivate":"updateStateParams"}function m(e,t){var n=u[e.name];if(!n)return null;if(!t)return n;var r=g(t,n.locals.globals.$stateParams,e.ownParams);return r?n:null}function g(t,n,r){!e.isArray(r)&&e.isObject(r)&&(r=s(r,["$$keys","$$values","$$equals","$$validates","$$new","$$parent"]));if(!r){r=[];for(var i in t)r.push(i)}for(var o=0;o<r.length;o++){var u=r[o];if(t[u]!=n[u])return!1}return!0}var y={getInactiveStates:function(){var t=[];return e.forEach(u,function(e){t.push(e)}),t},getInactiveStatesByParent:function(){return h()},processTransition:function(t){var s={inactives:[],enter:[],exit:[],keep:0},u=t.fromState.path,a=t.fromParams,f=t.toState.path,l=t.toParams,c=t.reloadStateTree,p=t.options,m=0,y=f[m];p.inherit&&(l=i(r,l||{},n.$current,t.toState));while(y&&y===u[m]&&g(l,a,y.ownParams))y=f[++m];s.keep=m;var b,w,E,S={},x=d(u,f,m),T=!!p.reload;for(b=m;b<f.length;b++){var N=x.to?v(f[b],l,c,T):"enter";T=T||N=="updateStateParams",s.enter[b]=N,N=="reactivate"&&(E=S[f[b].name]=f[b]),N=="updateStateParams"&&(w=S[f[b].name]=f[b])}E=E?E.self.name+".":"",w=w?w.self.name+".":"";var C=h(),k=[""].concat(o(u.slice(0,m),function(e){return e.self.name}));e.forEach(k,function(e){var t=C[e];for(var n=0;t&&n<t.length;n++){var r=t[n];!S[r.name]&&(!E||r.self.name.indexOf(E)!==0)&&(!w||r.self.name.indexOf(w)!==0)&&s.inactives.push(r)}});for(b=m;b<u.length;b++){var L="exit";x.from&&(s.inactives.push(u[b]),L="inactivate"),s.exit[b]=L}return s},stateInactivated:function(e){u[e.self.name]=e,e.self.status="inactive",e.self.onInactivate&&a.invoke(e.self.onInactivate,e.self,e.locals.globals)},stateReactivated:function(e){u[e.self.name]&&delete u[e.self.name],e.self.status="entered",e.self.onReactivate&&a.invoke(e.self.onReactivate,e.self,e.locals.globals)},stateExiting:function(t,n,r){var i={};e.forEach(n,function(e){i[e.self.name]=!0}),e.forEach(u,function(n,r){!i[r]&&n.includes[t.name]&&(c&&l.debug("Exiting "+r+" because it's a substate of "+t.name+" and wasn't found in ",i),n.self.onExit&&a.invoke(n.self.onExit,n.self,n.locals.globals),e.forEach(n.locals,function(e,t){delete f.locals[t]}),n.locals=null,n.self.status="exited",delete u[r])}),r&&a.invoke(r,t.self,t.locals.globals),t.locals=null,t.self.status="exited",delete u[t.self.name]},stateEntering:function(e,t,n,r){var i=m(e);if(i&&(r||!m(e,t))){var s=e.locals;this.stateExiting(i),e.locals=s}e.self.status="entered",n&&a.invoke(n,e.self,e.locals.globals)},reset:function(r,i){var s=n.get(r),o=m(s,i);return o?(y.stateExiting(o),t.$broadcast("$viewContentLoading"),!0):!1}};return y}]}function c(e){return{resolve:{},locals:{globals:o&&o.locals&&o.locals.globals},views:{},self:{},params:{},ownParams:l.hasParamSet?{$$equals:function(){return!0}}:[],surrogateType:e}}e.module("ct.ui.router.extras.sticky",["ct.ui.router.extras.core"]);var n=e.module("ct.ui.router.extras.sticky");r.$inject=["$stateProvider","uirextras_coreProvider"],n.provider("$stickyState",r);var i,s={},o,u=[],a,f,l={hasParamSet:!1};e.module("ct.ui.router.extras.sticky").run(["$stickyState",function(e){i=e}]),e.module("ct.ui.router.extras.sticky").config(["$provide","$stateProvider","$stickyStateProvider","$urlMatcherFactoryProvider","uirextras_coreProvider",function(n,r,s,h,p){function E(t,n,r){function s(e,t,n){return e[t]?e[t].toUpperCase()+": "+n.self.name:"("+n.self.name+")"}var o=y(r.inactives,function(e){return e.self.name}),u=y(n.toState.path,function(e,t){return s(r.enter,t,e)}),a=y(n.fromState.path,function(e,t){return s(r.exit,t,e)}),f=n.fromState.self.name+": "+e.toJson(n.fromParams)+": "+" -> "+n.toState.self.name+": "+e.toJson(n.toParams);t.debug("   Current transition: ",f),t.debug("Before transition, inactives are:   : ",y(i.getInactiveStates(),function(e){return e.self.name})),t.debug("After transition,  inactives will be: ",o),t.debug("Transition will exit:  ",a),t.debug("Transition will enter: ",u)}function S(e,t,n){e.debug("Current state: "+t.self.name+", inactive states: ",y(i.getInactiveStates(),function(e){return e.self.name}));var r=function(e,t){return"'"+t+"' ("+e.$$state.name+")"},s=function(e,t){return t!="globals"&&t!="resolve"},o=function(e){var t=y(b(e.locals,s),r).join(", ");return"("+(e.self.name?e.self.name:"root")+".locals"+(t.length?": "+t:"")+")"},u=o(t),a=t.parent;while(a&&a!==t)a.self.name===""&&(u=o(n.$current.path[0])+" / "+u),u=o(a)+" / "+u,t=a,a=t.parent;e.debug("Views: "+u)}var d=p,v=d.internalStates,m=d.inherit,g=d.inheritParams,y=d.map,b=d.filterObj;l.hasParamSet=!!h.ParamSet,f=e.extend(new c("__inactives"),{self:{name:"__inactives"}}),o=a=t,u=[],p.onStateRegistered(function(e){e.self.sticky===!0&&s.registerStickyState(e.self)});var w;n.decorator("$state",["$delegate","$log","$q",function(n,r,p){return o=n.$current,v[""]=o,o.parent=f,f.parent=t,o.locals=m(f.locals,o.locals),delete f.locals.globals,w=n.transitionTo,n.transitionTo=function(t,d,m){function H(t){var n=e.extend(new c("reactivate_phase1"),{locals:t.locals});return n.self=e.extend({},t.self),n}function B(t){var n=e.extend(new c("reactivate_phase2"),t),r=n.self.onEnter;return n.resolve={},n.views={},n.self.onEnter=function(){n.locals=t.locals,i.stateReactivated(t)},P.addRestoreFunction(function(){t.self.onEnter=r}),n}function j(e){var t=new c("inactivate");t.self=e.self;var n=e.self.onExit;return t.self.onExit=function(){i.stateInactivated(e)},P.addRestoreFunction(function(){e.self.onExit=n}),t}function F(e,t){var n=e.self.onEnter;return e.self.onEnter=function(){i.stateEntering(e,t,n)},P.addRestoreFunction(function(){e.self.onEnter=n}),e}function I(e,t){var n=e.self.onEnter;return e.self.onEnter=function(){i.stateEntering(e,t,n,!0)},P.addRestoreFunction(function(){e.self.onEnter=n}),e}function q(e){var t=e.self.onExit;return e.self.onExit=function(){i.stateExiting(e,M,t)},P.addRestoreFunction(function(){e.self.onExit=t}),e}var g=s.debugMode();f.locals||(f.locals=o.locals);var b=u.length;a&&(a(),g&&r.debug("Restored paths from pending transition"));var x=n.$current,T=n.params,N=m&&m.relative||n.$current,C=n.get(t,N),k,L,A,O=[],M=[],_;d=d||{},arguments[1]=d;var D=function(){},P=function(){k&&(R.path=k,k=null),L&&(x.path=L,L=null),e.forEach(P.restoreFunctions,function(e){e()}),P=D,a=null,u.splice(b,1)};P.restoreFunctions=[],P.addRestoreFunction=function(t){this.restoreFunctions.push(t)};if(C){var R=v[C.name];if(R){k=R.path,L=x.path;var U=m&&m.reload||!1,z=U&&(U===!0?k[0].self:n.get(U,N));m&&U&&U!==!0&&delete m.reload;var W={toState:R,toParams:d||{},fromState:x,fromParams:T||{},options:m,reloadStateTree:z};u.push(W),a=P;if(z){W.toParams.$$uirouterextrasreload=Math.random();var X=z.$$state().params,V=z.$$state().ownParams;if(l.hasParamSet){var $=new h.Param("$$uirouterextrasreload");X.$$uirouterextrasreload=V.$$uirouterextrasreload=$,P.restoreFunctions.push(function(){delete X.$$uirouterextrasreload,delete V.$$uirouterextrasreload})}else X.push("$$uirouterextrasreload"),V.push("$$uirouterextrasreload"),P.restoreFunctions.push(function(){X.length=X.length-1,V.length=V.length-1})}A=i.processTransition(W),g&&E(r,W,A);var J=R.path.slice(0,A.keep),K=x.path.slice(0,A.keep);e.forEach(f.locals,function(e,t){t.indexOf("@")!=-1&&delete f.locals[t]});for(var Q=0;Q<A.inactives.length;Q++){var G=A.inactives[Q].locals;e.forEach(G,function(e,t){G.hasOwnProperty(t)&&t.indexOf("@")!=-1&&(f.locals[t]=e)})}e.forEach(A.enter,function(e,t){var n,r=R.path[t];e==="reactivate"?(n=H(r),J.push(n),K.push(n),O.push(B(r)),_=r):e==="updateStateParams"?(n=I(r),J.push(n),_=r):e==="enter"&&J.push(F(r))}),e.forEach(A.exit,function(e,t){var n=x.path[t];e==="inactivate"?(K.push(j(n)),M.push(n)):e==="exit"&&(K.push(q(n)),M.push(n))}),O.length&&e.forEach(O,function(e){J.push(e)});if(R===_){var Y=_.self.name+".",Z=i.getInactiveStates(),et=[];Z.forEach(function(e){e.self.name.indexOf(Y)===0&&et.push(e)}),et.sort(),et.reverse(),K=K.concat(y(et,function(e){return q(e)})),M=M.concat(et)}R.path=J,x.path=K;var tt=function(e){return(e.surrogateType?e.surrogateType+":":"")+e.self.name};g&&r.debug("SurrogateFromPath: ",y(K,tt)),g&&r.debug("SurrogateToPath:   ",y(J,tt))}}var nt=w.apply(n,arguments);return nt.then(function(t){return P(),g&&S(r,v[t.name],n),t.status="active",t},function(t){return P(),g&&t.message!=="transition prevented"&&t.message!=="transition aborted"&&t.message!=="transition superseded"&&(r.debug("transition failed",t),console.log(t.stack)),p.reject(t)})},n}])}])})(angular)