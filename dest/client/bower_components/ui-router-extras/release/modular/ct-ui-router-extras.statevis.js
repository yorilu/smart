/**

 * UI-Router Extras: Sticky states, Future States, Deep State Redirect, Transition promise
 * Module: statevis
 * @version 0.0.13
 * @link http://christopherthielen.github.io/ui-router-extras/
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */

(function(e,t){(function(){function n(t,n,r){return{scope:{width:"@",height:"@"},restrict:"AE",template:"<svg></svg>",link:function(n,i,s){function E(t){t=t.map(function(t){return t.name===""?l:e.copy(t)}),e.extend(o,t.reduce(function(e,t){return e[t.name]=t,e},{})),t.forEach(function(e){var t=e.name.split(/\./).slice(0,-1).join("."),n=e.name!=t&&o[t];n&&((n.children||(n.children=[])).push(e),e.px=n.px,e.py=n.py,c.push(e))})}function S(){function t(e){var t=e.name.split(".").pop();return e.sticky&&(t+=" (STICKY)"),e.deepStateRedirect&&(t+=" (DSR)"),t}v=v.data(f.nodes(l),function(e){return e.name}),m=m.data(f.links(c),function(e){return e.target.name}),g=g.data(h),c.forEach(function(e){e.y=e.depth*70});var e=v.enter();g.enter().append("circle").attr("class","active").attr("r",13).attr("cx",function(e){return e.parent.px||100}).attr("cy",function(e){return e.parent.py||100}),e.append("circle").attr("class","node").attr("r",9).attr("cx",function(e){return e.parent.px}).attr("cy",function(e){return e.parent.py}),e.append("text").attr("class","label").attr("x",function(e){return e.parent.px}).attr("y",function(e){return e.parent.py}).attr("text-anchor",function(e){return"middle"}).text(t).style("fill-opacity",1),m.enter().insert("path",".node").attr("class","link").attr("d",function(e){var t={x:e.source.px,y:e.source.py};return p({source:t,target:t})});var n=d.transition().duration(b);n.selectAll(".link").attr("d",p);var r={entered:"#AF0",exited:"#777",active:"#0f0",inactive:"#55F",future:"#009"};n.selectAll(".node").attr("cx",function(e){return e.px=e.x}).attr("cy",function(e){return e.py=e.y}).attr("r",function(e){return e.status==="active"?15:10}).style("fill",function(e){return r[e.status]||"#FFF"}),n.selectAll(".label").attr("x",function(e){return e.px=e.x}).attr("y",function(e){return e.py=e.y-15}).attr("transform",function(e){return"rotate(-25 "+e.x+" "+e.y+")"}),n.selectAll(".active").attr("x",function(e){return e.px=e.x}).attr("y",function(e){return e.py=e.y-15})}var o={},u=n.width||400,a=n.height||400,f=d3.layout.tree().size([u-20,a-20]).separation(function(e,t){return e.parent==t.parent?10:25}),l=t.get().filter(function(e){return e.name===""})[0],c=f(l);l.parent=l,l.px=l.x=u/2,l.py=l.y=a/2;var h={};h.px=h.x=l.px,h.py=h.y=l.py;var p=d3.svg.diagonal(),d=d3.select(i.find("svg")[0]).attr("width",u).attr("height",a).append("g").attr("transform","translate(10, 10)"),v=d.selectAll(".node"),m=d.selectAll(".link"),g=d.selectAll(".active"),y=200,b=200,w=setInterval(S,y);r(function(){n.states=t.get(),e.forEach(c,function(e){var n=t.get(e.name);n&&(e.status=n.status||"exited")})},250),n.$watchCollection("states",function(e,t){var n=(t||[]).map(function(e){return e.name});E((e||[]).filter(function(e){return n.indexOf(e.name)==-1}))}),S(y)}}}var t=e.module("ct.ui.router.extras.statevis",["ct.ui.router.extras.core","ct.ui.router.extras.sticky"]);t.directive("stateVis",["$state","$timeout","$interval",n])})()})(angular)