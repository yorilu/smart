!function(e){!function(){function n(n,r,i){return{scope:{width:"@",height:"@"},restrict:"AE",template:"<svg></svg>",link:function(r,s){function o(n){n=n.map(function(n){return""===n.name?h:e.copy(n)}),e.extend(a,n.reduce(function(e,t){return e[t.name]=t,e},{})),n.forEach(function(e){var t=e.name.split(/\./).slice(0,-1).join("."),n=e.name!=t&&a[t];n&&((n.children||(n.children=[])).push(e),e.px=n.px,e.py=n.py,p.push(e))})}function u(){function e(e){var t=e.name.split(".").pop();return e.sticky&&(t+=" (STICKY)"),e.deepStateRedirect&&(t+=" (DSR)"),t}g=g.data(c.nodes(h),function(e){return e.name}),y=y.data(c.links(p),function(e){return e.target.name}),b=b.data(d),p.forEach(function(e){e.y=70*e.depth});var t=g.enter();b.enter().append("circle").attr("class","active").attr("r",13).attr("cx",function(e){return e.parent.px||100}).attr("cy",function(e){return e.parent.py||100}),t.append("circle").attr("class","node").attr("r",9).attr("cx",function(e){return e.parent.px}).attr("cy",function(e){return e.parent.py}),t.append("text").attr("class","label").attr("x",function(e){return e.parent.px}).attr("y",function(e){return e.parent.py}).attr("text-anchor",function(){return"middle"}).text(e).style("fill-opacity",1),y.enter().insert("path",".node").attr("class","link").attr("d",function(e){var t={x:e.source.px,y:e.source.py};return v({source:t,target:t})});var n=m.transition().duration(E);n.selectAll(".link").attr("d",v);var r={entered:"#AF0",exited:"#777",active:"#0f0",inactive:"#55F",future:"#009"};n.selectAll(".node").attr("cx",function(e){return e.px=e.x}).attr("cy",function(e){return e.py=e.y}).attr("r",function(e){return"active"===e.status?15:10}).style("fill",function(e){return r[e.status]||"#FFF"}),n.selectAll(".label").attr("x",function(e){return e.px=e.x}).attr("y",function(e){return e.py=e.y-15}).attr("transform",function(e){return"rotate(-25 "+e.x+" "+e.y+")"}),n.selectAll(".active").attr("x",function(e){return e.px=e.x}).attr("y",function(e){return e.py=e.y-15})}var a={},f=r.width||400,l=r.height||400,c=d3.layout.tree().size([f-20,l-20]).separation(function(e,t){return e.parent==t.parent?10:25}),h=n.get().filter(function(e){return""===e.name})[0],p=c(h);h.parent=h,h.px=h.x=f/2,h.py=h.y=l/2;var d={};d.px=d.x=h.px,d.py=d.y=h.py;var v=d3.svg.diagonal(),m=d3.select(s.find("svg")[0]).attr("width",f).attr("height",l).append("g").attr("transform","translate(10, 10)"),g=m.selectAll(".node"),y=m.selectAll(".link"),b=m.selectAll(".active"),w=200,E=200;setInterval(u,w),i(function(){r.states=n.get(),e.forEach(p,function(e){var t=n.get(e.name);t&&(e.status=t.status||"exited")})},250),r.$watchCollection("states",function(e,t){var n=(t||[]).map(function(e){return e.name});o((e||[]).filter(function(e){return-1==n.indexOf(e.name)}))}),u(w)}}}var r=e.module("ct.ui.router.extras.statevis",["ct.ui.router.extras.core","ct.ui.router.extras.sticky"]);r.directive("stateVis",["$state","$timeout","$interval",n])}()}(angular)