/**

 * UI-Router Extras: Sticky states, Future States, Deep State Redirect, Transition promise
 * Module: future
 * @version 0.0.13
 * @link http://christopherthielen.github.io/ui-router-extras/
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */

(function(e,t){(function(e,t){function r(t,n,r,i){function d(t,n){var r=e.isObject(t)?t.name:t;return n?a[r]:o[r]}function v(e,t){if(t.name){var n=t.name.split(/\./);t.name.charAt(0)==="."&&(n[0]=e.current.name);while(n.length){var r=n.join(".");if(e.get(r,{relative:e.current}))return null;if(a[r])return a[r];n.pop()}}if(t.url){var i=[];for(var s in a){var o=a[s].urlMatcher;o&&o.exec(t.url)&&i.push(a[s])}var u=i.slice(0);for(var f=i.length-1;f>=0;f--)for(var l=0;l<u.length;l++)i[f]===u[l].parentFutureState&&i.splice(f,1);return i[0]}}function m(e,t){f=!0;var n=e.get("$q");if(!t){var r=n.defer();return r.reject("No lazyState passed in "+t),r.promise}var i=n.when([]),s=t.parentFutureState;s&&a[s.name]&&(i=m(e,a[s.name]));var o=t.type,l=u[o];if(!l)throw Error("No state factory for futureState.type: "+(t&&t.type));return i.then(function(n){var r=e.invoke(l,l,{futureState:t});return r.then(function(e){return e&&n.push(e),n})})["finally"](function(){delete a[t.name]})}function y(e,n){var r=!1,i=["$rootScope","$urlRouter","$state",function(s,o,u){function a(){r=!0,o.sync(),r=!1}if(!h){c().then(a),h=!0;return}var l=v(u,{url:n.path()});if(!l)return e.invoke(g);m(e,l).then(function(n){n.forEach(function(e){e&&(!u.get(e)||e.name&&!u.get(e.name))&&t.state(e)}),f=!1,a()},function(){f=!1,a()})}];if(f)return;var s=r?g:i;return e.invoke(s)}var s=i,o=s.internalStates,u={},a={},f=!1,l=[],c,h=!1,p=this;this.addResolve=function(e){l.push(e)},this.stateFactory=function(e,t){u[e]=t},this.futureState=function(t){t.stateName&&(t.name=t.stateName),t.urlPrefix&&(t.url="^"+t.urlPrefix),a[t.name]=t;var n,i=t.name.split(/\./).slice(0,-1).join("."),s=d(t.parent||i);if(s)n=s.url||s.navigable.url;else if(i==="")n=r.compile("");else{var o=d(t.parent||i,!0);if(!o)throw new Error("Couldn't determine parent state of future state. FutureState:"+e.toJson(t));var u=o.urlMatcher.source.replace(/\*rest$/,"");n=r.compile(u),t.parentFutureState=o}t.url&&(t.urlMatcher=t.url.charAt(0)==="^"?r.compile(t.url.substring(1)+"*rest"):n.concat(t.url+"*rest"))},this.get=function(){return e.extend({},a)};var g=["$log","$location",function(t,n){t.debug("Unable to map "+n.path())}];n.otherwise(y),n.otherwise=function(t){if(e.isString(t)){var r=t;t=function(){return r}}else if(!e.isFunction(t))throw new Error("'rule' must be a function");return g=["$injector","$location",t],n};var b={getResolvePromise:function(){return c()}};this.$get=["$injector","$state","$q","$rootScope","$urlRouter","$timeout","$log",function(r,i,s,o,u,a,h){function d(){o.$on("$stateNotFound",function(n,s,o,u){if(f)return;h.debug("event, unfoundState, fromState, fromParams",n,s,o,u);var a=v(i,{name:s.to});if(!a)return;n.preventDefault();var l=m(r,a);l.then(function(e){e.forEach(function(e){e&&(!i.get(e)||e.name&&!i.get(e.name))&&t.state(e)}),i.go(s.to,s.toParams),f=!1},function(e){console.log("failed to lazy load state ",e),i.go(o,u),f=!1})});if(!c){var n=[];e.forEach(l,function(e){n.push(r.invoke(e))}),c=function(){return s.all(n)}}c().then(function(){a(function(){i.transition?i.transition.then(u.sync,u.sync):u.sync()})})}return d(),b.state=t.state,b.futureState=p.futureState,b.get=p.get,b}]}var n=e.module("ct.ui.router.extras.future",["ct.ui.router.extras.core"]);r.$inject=["$stateProvider","$urlRouterProvider","$urlMatcherFactoryProvider","uirextras_coreProvider"],n.provider("$futureState",r);var i={state:function(e){i.$rootScope&&i.$rootScope.$broadcast("$stateAdded",e)},itsNowRuntimeOhWhatAHappyDay:function(e){i.$rootScope=e},$rootScope:t};n.config(["$stateProvider",function(t){var n=t.state;t.state=function(){var s=n.apply(t,arguments),o=e.isObject(arguments[0])?arguments[0]:arguments[1];return i.state(o),s}}]),n.run(["$futureState",function(e,t){i.itsNowRuntimeOhWhatAHappyDay(t)}])})(e)})(angular)