/*!
 * gulp
 * $ npm install gulp-jshint gulp-concat gulp-uglify gulp-notify gulp-rename gulp-wrap karma del --save-dev
 */

function testModule(e,t){function a(e){e===0?s.resolve():s.reject()}var n=require("karma").server,r=require("q"),i=require("./test/conf/karma.dynamic.conf");i.extrasModule=e;var s=r.defer(),o,u={configFile:__dirname+"/test/conf/karma.any.conf.js"};switch(t){case"debug":o={singleRun:!1,browsers:["Chrome"]};break;case"watch":o={singleRun:!1,browsers:["PhantomJS"]};break;default:o={singleRun:!0,browsers:["PhantomJS"]}}return n.start(_.extend(u,o),a),s.promise}var gulp=require("gulp"),_=require("lodash"),notify=require("gulp-notify"),uirExtrasModules=require("./files"),banners=require("./banners.json"),pkg=require("./package.json");gulp.task("scripts",["clean"],function(){var e=require("gulp-jshint"),t=require("gulp-rename"),n=require("gulp-concat"),r=require("gulp-uglify"),i=require("gulp-wrap"),s=undefined;return _.each(uirExtrasModules,function(o){var u=o.module=="all"?"Monolithic build (all modules)":"Module: "+o.module;s=gulp.src(o.src).pipe(e.reporter("default")).pipe(n(o.dist)).pipe(i("(function(angular, undefined){\n\n<%= contents %>\n})(angular);")).pipe(i(banners.banner.join("\n")+"\n<%= contents %>\n",{pkg:pkg,module:u})).pipe(gulp.dest(o.dest)).pipe(t({suffix:".min"})).pipe(r()).pipe(i(banners.minbanner.join("\n")+"\n<%= contents %>\n",{pkg:pkg,module:u})).pipe(gulp.dest(o.dest)).pipe(notify({message:"built "+o.module}));if(!s)return s}),s}),gulp.task("clean",function(e){var t=require("del");t(["build/**/*"],e)}),gulp.task("default",["clean"],function(){var e=require("run-sequence");e("karma:modules","karma:versions")}),gulp.task("karma:modules",["scripts"],function(){var e=require("karma").server,t=require("q"),n=t(!0);return _.each(uirExtrasModules,function(e){n=n.then(_.partial(testModule,e.module))}),n}),gulp.task("karma:versions",["scripts"],function(){var e=require("karma").server,t=require("q"),n=["0.2.8","0.2.10","0.2.12","0.2.13"],r=require("./test/conf/karma.dynamic.conf"),i=t(!0);return _.each(n,function(e){i=i.then(function(){return r.uiRouter=e,testModule("all")})}),i}),gulp.task("karma:watch",["scripts"],function(){return testModule("all.watch","watch")}),gulp.task("karma:debug",["scripts"],function(){return testModule("all.watch","debug")}),gulp.task("changelog",function(){require("conventional-changelog")({repository:"https://github.com/christopherthielen/ui-router-extras",version:require("./package.json").version},function(e,t){console.log("Here is your changelog!",t)})})